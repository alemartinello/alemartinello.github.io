<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-12-21">
<meta name="description" content="Why SQL ought really to be a staple in the toolbox of anyone working with data - in or outside academia.">

<title>Teach SQL in (grad) school</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-a652c116b21f402b806f3cbc5a90424b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<meta name="mermaid-theme" content="neutral">
<script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../tidbits.html"> 
<span class="menu-text">Tidbits</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../research.html"> 
<span class="menu-text">Research</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://dk.linkedin.com/in/alessandro-martinello-a2766823" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="https://github.com/alemartinello" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#teach-sql-in-grad-school" id="toc-teach-sql-in-grad-school" class="nav-link active" data-scroll-target="#teach-sql-in-grad-school">Teach SQL in (grad) school</a></li>
  <li><a href="#most-academic-economists-never-really-pick-up-sql" id="toc-most-academic-economists-never-really-pick-up-sql" class="nav-link" data-scroll-target="#most-academic-economists-never-really-pick-up-sql">Most academic economists never really pick up SQL</a></li>
  <li><a href="#but-isnt-sql-just-a-weird-way-to-download-data-from-a-remote-database" id="toc-but-isnt-sql-just-a-weird-way-to-download-data-from-a-remote-database" class="nav-link" data-scroll-target="#but-isnt-sql-just-a-weird-way-to-download-data-from-a-remote-database">But isn’t SQL just a weird way to download data from a remote database?</a></li>
  <li><a href="#use-your-computing-resources-efficiently" id="toc-use-your-computing-resources-efficiently" class="nav-link" data-scroll-target="#use-your-computing-resources-efficiently">Use your computing resources efficiently</a>
  <ul class="collapse">
  <li><a href="#load-only-the-data-you-need" id="toc-load-only-the-data-you-need" class="nav-link" data-scroll-target="#load-only-the-data-you-need">Load only the data you need</a></li>
  <li><a href="#join-join-join" id="toc-join-join-join" class="nav-link" data-scroll-target="#join-join-join">Join, join, join</a></li>
  </ul></li>
  <li><a href="#summing-up" id="toc-summing-up" class="nav-link" data-scroll-target="#summing-up">Summing up</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Teach SQL in (grad) school</h1>
  <div class="quarto-categories">
    <div class="quarto-category">analytics</div>
  </div>
  </div>

<div>
  <div class="description">
    Why SQL ought really to be a staple in the toolbox of anyone working with data - in or outside academia.
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 21, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>On December 12 I gave a workshop to a small crowd for the series <a href="https://sites.google.com/view/dariia-mykhailyshyna/main/r-workshops-for-ukraine">Workshops for Ukraine</a>, organized by <a href="https://sites.google.com/view/dariia-mykhailyshyna/main">Dariia Mykhailyshyna</a>.</p>
<p>Besides being happy to a tiny little contribution to the Ukranian cause, it was a perfect opportunity to</p>
<ul>
<li>Write down some <a href="https://github.com/alemartinello/BigDataMadeSmall">material I have long wanted to share</a>.</li>
<li>Disseminate to academics the value of using SQL when working with data</li>
</ul>
<p>Which brings me to one of my greatest wishes towards higher education (in Denmark, at least).</p>
<section id="teach-sql-in-grad-school" class="level2">
<h2 class="anchored" data-anchor-id="teach-sql-in-grad-school">Teach SQL in (grad) school</h2>
<p>Pushing SQL into university classes is one of my pet peeves. I am honored to be among the “industry panel” (a forum where prospective employers can give input to the direction of a course of studies) for the <a href="https://www.ku.dk/studies/bachelor/cognitive-data-science">bachelor in cognitive data science</a> and the <a href="https://www.ku.dk/studies/masters/social-data-science">master in social data science</a> at Copenhagen University. Pushing SQL in class teachings is one of the points I bring back to each and every meeting.</p>
<p>SQL has consistently been around for about 40 years, and nothing points to it being less relevant going forward. On the contrary, business analytics is increasingly dependent on it. Further, while once you had to set up a SQL database, and ideally a server, for taking advantage of database engines, recent advances in the availability of self-contained database engines like <a href="https://duckdb.org/">DuckDB</a> make it accessible to anyone who can run an R or a python script. I have used SQL daily at both <a href="https://nationalbanken.dk">Danmark Nationalbank</a> and <a href="https://rd.dk">Realkredit Danmark</a>.</p>
<p><strong>Yet none of the people I have ever hired directly after university knew it.</strong></p>
<p>It’s a skill that has to be taught at work. It takes time, it takes errors, it prolongs the time gap between “<em>just focus on learning</em>” and “<em>you can actually start helping me for real</em>” for newly educated hires. At the same time, I have to make them unlearn all their <code>pandas</code> workflow, and <em>smart <code>pandas</code> hacks</em> they have taught themselves to solve issues that are really best solved by a good old SQL query.</p>
<p>So why is this blatant mismatch between data skills taught at unis and required outside of academia occurring?</p>
<p>My thesis is simple.</p>
</section>
<section id="most-academic-economists-never-really-pick-up-sql" class="level2">
<h2 class="anchored" data-anchor-id="most-academic-economists-never-really-pick-up-sql">Most academic economists never really pick up SQL</h2>
<p>And thereby, they fail to realize its usefulness.</p>
<p>And that’s true even for data people, very good at coding in R or python or Julia or whatever else. I know, because I was one of them.</p>
<p>It’s a recurring circle of missed opportunities. Econ professors do not know SQL, so they don’t teach it at school. The students going to the private sector will learn it, but those pursuing an academic career are never exposed to it, and never realize what it can. At best, they have heard about it and regard it as “some sort of old-school, weird way to extract data from remote databases”. So when it’s their turn to teach data classes, they do not teach it.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">block-beta
  columns 3
  space A(["Professors do \nnot know SQL"]) space
  B(["Professors do not\nteach SQL to\ngrad students"]) space D(["Grad students\nbecome professors"])
  space C(["Grad students\ndo not know SQL"]) space
  A --&gt; B 
  B --&gt; C 
  C --&gt; D
  D --&gt; A

</pre>
</div>
<p></p><figcaption> The recurring circle of misssed opportunities</figcaption> </figure><p></p>
</div>
</div>
</div>
<p>At the same time, compared to fields like law, or medicine, the “real world” of the private sectors is an absorbing state. People like me, going from academia to the private sector, do not ever go back, even just for teaching a class.</p>
<p>This post, maybe the first in a series, is meant to showcase why SQL ought really to be a staple in the toolbox of anyone working with data - in or outside academia. The focus of this post will be showcasing how SQL allows you to <strong>use your computing resources efficiently</strong>. And thereby, <a href="https://www.pnas.org/doi/10.1073/pnas.2317589121">working with larger-than-RAM data</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
But what about speed?
</div>
</div>
<div class="callout-body-container callout-body">
<p>A great seeling point of tools like <a href="https://duckdb.org">DuckDB</a> is that they allow you to do the same stuff you’d do in <code>pandas</code> or <code>dplyr</code> <a href="https://h2oai.github.io/db-benchmark/"><strong>way faster</strong></a>.</p>
<p>There’s a lot that has been written on this already however, and I’d refer to <a href="https://grantmcdermott.com/duckdb-polars/">this post</a> by <a href="https://bsky.app/profile/gmcd.bsky.social">Grant McDermott</a> if you want to know more.</p>
<p>Furthermore, focus on efficiency is also a focus on speed. Using resource optimally is one of the main reasons database engines are fast at data processing.</p>
</div>
</div>
</section>
<section id="but-isnt-sql-just-a-weird-way-to-download-data-from-a-remote-database" class="level2">
<h2 class="anchored" data-anchor-id="but-isnt-sql-just-a-weird-way-to-download-data-from-a-remote-database">But isn’t SQL just a weird way to download data from a remote database?</h2>
<p>…And <em>then</em> do the <strong><em>real</em></strong> data work in python or R?</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
NO
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<p>This is often the first misconception to eliminate. You can of course use SQL this way, like an ill-devised FTP tool. You can also choose to cut a steak with a scissor. Neither is a good idea: you’d be using the wrong tool for the intended purpose.</p>
<p>The point of SQL is very much not of downloading all available data from a remote server. In fact, SQL is used for the opposite: Selecting only the data you need and <strong>minimize</strong> the flow between where the data resides, and where it needs to be loaded to (your RAM).</p>
<p>But the second, understandable misconception, is that using SQL:</p>
<ul>
<li>Requires setting up a database of sorts</li>
<li>Is kind of pointless when working with local data</li>
</ul>
<blockquote class="bluesky-embed blockquote" data-bluesky-uri="at://did:plc:chnj7asmuhas2tr2isqz7kuj/app.bsky.feed.post/3ldqrsaibic2e" data-bluesky-cid="bafyreihiqr6h3fvu65adzex7tqmcv5wuqo4g2hwbokvjpyfwia6c7npl7m">
<p lang="en">
</p><p>I'm still not sure I understand the benefits.</p>
<p>Is it that the WHERE commands are so intuitive in SQL? I could do a similar query very easily in dplyr.</p>
Is it the size of the data? I could use feather in R or just work on the cluster.
<p></p>
— Peter Deffebach (<a href="https://bsky.app/profile/did:plc:chnj7asmuhas2tr2isqz7kuj?ref_src=embed"><span class="citation" data-cites="macrodev.bsky.social">@macrodev.bsky.social</span></a>) <a href="https://bsky.app/profile/did:plc:chnj7asmuhas2tr2isqz7kuj/post/3ldqrsaibic2e?ref_src=embed">December 20, 2024 at 5:14 PM</a>
</blockquote>
<script async="" src="https://embed.bsky.app/static/embed.js" charset="utf-8"></script>
<p>Peter’s question is a fair one. Why should we bother?</p>
</section>
<section id="use-your-computing-resources-efficiently" class="level2">
<h2 class="anchored" data-anchor-id="use-your-computing-resources-efficiently">Use your computing resources efficiently</h2>
<p>In my opinion, the main point of SQL is that it is designed to use resources efficiently. Both when querying, and when storing data (hence <a href="https://www.ibm.com/think/topics/relational-databases">relational databases</a>).</p>
<p>The need for efficiency is often lost because of today’s superpowered hardware. During my PhD, I worked on a remote windows server with 5GB RAM available for data and shared across a dozen of so researchers. Today, a MacBook Pro ships with minimum 16GB RAM. Computers are extremely fast, and cloud computing is easily accessible.</p>
<p>And yet, I have always disliked wasting resources. Why waiting minutes when a data tasks can be done in seconds? What if you encounter a truly large dataset? Are you willing to wait hours just because you are including in your workflow tons of data you do not actually need?</p>
<p>In the sections below I will use <a href="https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page">NYC’s yellow taxi cab data</a> for a few examples. In line with Peter’s question above, I simply downloaded the <a href="https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2024-10.parquet">parquet with October 2024</a> data and saved it locally. Imagine this as a very simple local data source.</p>
<div id="bbd468fd" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.request</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>savedfile <span class="op">=</span> Path.cwd() <span class="op">/</span> <span class="st">'yellow_tripdata_2024-10.parquet'</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> savedfile.is_file():</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">pass</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  urllib.request.urlretrieve(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2024-10.parquet"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"yellow_tripdata_2024-10.parquet"</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As hinted several times already, I’ll be using <a href="https://duckdb.org">duckdb</a> to work with the data.</p>
<div id="b8173c86" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>I use basic <code>SELECT</code> statements throughout the examples below. I do not explain these statements in this post, but I include the code for each example.</p>
<p>I might write a blog post with an introduction to <code>SELECT</code> statements, but for now I refer to <a href="https://github.com/alemartinello/BigDataMadeSmall/blob/master/Workshop/The_basics.ipynb">this notebook</a>.</p>
</div>
</div>
<section id="load-only-the-data-you-need" class="level3">
<h3 class="anchored" data-anchor-id="load-only-the-data-you-need">Load only the data you need</h3>
<p>The whole point of using SQL is that you <strong>never</strong> need to load <strong>all</strong> of the available raw data in your system. That’s the whole point of data pipelines and data cleaning.</p>
<p>There’ll be columns you do not need, rows you need to exclude. You might think “but it takes no time anyway”. Sure, with our overpowered machines. But every time we do unnecessary operations we throw sand in the cogs of our machine.</p>
<p>Doing so can be rational: After all, I do not code in C++. My time is also money. But loading tons of unnecessary data into our RAM, for discarding them right afterwards is a clear and easily avoidable waste of resources.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
But I need to explore the data!
</div>
</div>
<div class="callout-body-container callout-body">
<p>Indeed.</p>
<p>Data exploration DOES NOT require loading the whole thing into the RAM. I definitely do not need to look at <strong>every single row</strong> and <strong>every single column</strong> to understand how I can use a dataset.</p>
<p>Mostly, you want to extract specific examples, doing some aggregates. All things SQL excels at.</p>
</div>
</div>
<p>So let’s see what the first five rows of the data we downloaded contains.</p>
<div id="3125f295" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>duckdb.sql(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">  select *</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">  from 'yellow_tripdata_2024-10.parquet'</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">  limit 5</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">  """</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>┌──────────┬──────────────────────┬───────────────────────┬─────────────────┬───────────────┬────────────┬────────────────────┬──────────────┬──────────────┬──────────────┬─────────────┬────────┬─────────┬────────────┬──────────────┬───────────────────────┬──────────────┬──────────────────────┬─────────────┐
│ VendorID │ tpep_pickup_datetime │ tpep_dropoff_datetime │ passenger_count │ trip_distance │ RatecodeID │ store_and_fwd_flag │ PULocationID │ DOLocationID │ payment_type │ fare_amount │ extra  │ mta_tax │ tip_amount │ tolls_amount │ improvement_surcharge │ total_amount │ congestion_surcharge │ Airport_fee │
│  int32   │      timestamp       │       timestamp       │      int64      │    double     │   int64    │      varchar       │    int32     │    int32     │    int64     │   double    │ double │ double  │   double   │    double    │        double         │    double    │        double        │   double    │
├──────────┼──────────────────────┼───────────────────────┼─────────────────┼───────────────┼────────────┼────────────────────┼──────────────┼──────────────┼──────────────┼─────────────┼────────┼─────────┼────────────┼──────────────┼───────────────────────┼──────────────┼──────────────────────┼─────────────┤
│        2 │ 2024-10-01 00:30:44  │ 2024-10-01 00:48:26   │               1 │           3.0 │          1 │ N                  │          162 │          246 │            1 │        18.4 │    1.0 │     0.5 │        1.5 │          0.0 │                   1.0 │         24.9 │                  2.5 │         0.0 │
│        1 │ 2024-10-01 00:12:20  │ 2024-10-01 00:25:25   │               1 │           2.2 │          1 │ N                  │           48 │          236 │            1 │        14.2 │    3.5 │     0.5 │        3.8 │          0.0 │                   1.0 │         23.0 │                  2.5 │         0.0 │
│        1 │ 2024-10-01 00:04:46  │ 2024-10-01 00:13:52   │               1 │           2.7 │          1 │ N                  │          142 │           24 │            1 │        13.5 │    3.5 │     0.5 │        3.7 │          0.0 │                   1.0 │         22.2 │                  2.5 │         0.0 │
│        1 │ 2024-10-01 00:12:10  │ 2024-10-01 00:23:01   │               1 │           3.1 │          1 │ N                  │          233 │           75 │            1 │        14.2 │    3.5 │     0.5 │        2.0 │          0.0 │                   1.0 │         21.2 │                  2.5 │         0.0 │
│        1 │ 2024-10-01 00:30:22  │ 2024-10-01 00:30:39   │               1 │           0.0 │          1 │ N                  │          262 │          262 │            3 │         3.0 │    3.5 │     0.5 │        0.0 │          0.0 │                   1.0 │          8.0 │                  2.5 │         0.0 │
└──────────┴──────────────────────┴───────────────────────┴─────────────────┴───────────────┴────────────┴────────────────────┴──────────────┴──────────────┴──────────────┴─────────────┴────────┴─────────┴────────────┴──────────────┴───────────────────────┴──────────────┴──────────────────────┴─────────────┘</code></pre>
</div>
</div>
<p>Cool. Just gotten the first 5 rows out. One could already see some patterns and some data of use.</p>
<p>But I wonder, can I describe all variables similarly to a <code>pandas.DataFrame.describe()</code>? With DuckDB, sure</p>
<div id="2510e169" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>duckdb.sql(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="st">  SUMMARIZE SELECT * from 'yellow_tripdata_2024-10.parquet'</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="st">  """</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>).df()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column_name</th>
<th data-quarto-table-cell-role="th">column_type</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">max</th>
<th data-quarto-table-cell-role="th">approx_unique</th>
<th data-quarto-table-cell-role="th">avg</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">q25</th>
<th data-quarto-table-cell-role="th">q50</th>
<th data-quarto-table-cell-role="th">q75</th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">null_percentage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>VendorID</td>
<td>INTEGER</td>
<td>1</td>
<td>6</td>
<td>3</td>
<td>1.767158236629157</td>
<td>0.4231049313968447</td>
<td>2</td>
<td>2</td>
<td>2</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>tpep_pickup_datetime</td>
<td>TIMESTAMP</td>
<td>2009-01-01 00:35:59</td>
<td>2024-11-14 18:30:00</td>
<td>1646536</td>
<td>None</td>
<td>None</td>
<td>2024-10-09 14:26:10.066878</td>
<td>2024-10-17 02:39:44.162982</td>
<td>2024-10-24 17:46:05.259919</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>tpep_dropoff_datetime</td>
<td>TIMESTAMP</td>
<td>2009-01-01 01:29:28</td>
<td>2024-11-14 18:41:41</td>
<td>1673214</td>
<td>None</td>
<td>None</td>
<td>2024-10-09 15:00:32.457971</td>
<td>2024-10-17 04:35:02.69613</td>
<td>2024-10-24 18:05:48.686127</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>passenger_count</td>
<td>BIGINT</td>
<td>0</td>
<td>9</td>
<td>11</td>
<td>1.308449781329327</td>
<td>0.76773460811274</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>3833771</td>
<td>10.27</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>trip_distance</td>
<td>DOUBLE</td>
<td>0.0</td>
<td>366343.04</td>
<td>3580</td>
<td>5.123568288246284</td>
<td>486.9214199492435</td>
<td>1.0236470768272852</td>
<td>1.7703947295351523</td>
<td>3.408899640526454</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>RatecodeID</td>
<td>BIGINT</td>
<td>1</td>
<td>99</td>
<td>7</td>
<td>2.3393857801850997</td>
<td>10.972502420745363</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>3833771</td>
<td>10.27</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>store_and_fwd_flag</td>
<td>VARCHAR</td>
<td>N</td>
<td>Y</td>
<td>2</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>3833771</td>
<td>10.27</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>PULocationID</td>
<td>INTEGER</td>
<td>1</td>
<td>265</td>
<td>290</td>
<td>164.48797776393008</td>
<td>64.3353498901592</td>
<td>132</td>
<td>161</td>
<td>233</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>DOLocationID</td>
<td>INTEGER</td>
<td>1</td>
<td>265</td>
<td>272</td>
<td>163.9748793029109</td>
<td>69.61100435412126</td>
<td>114</td>
<td>162</td>
<td>234</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>payment_type</td>
<td>BIGINT</td>
<td>0</td>
<td>4</td>
<td>5</td>
<td>1.0994349949436208</td>
<td>0.6603012949509145</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>fare_amount</td>
<td>DOUBLE</td>
<td>-920.0</td>
<td>1680.2</td>
<td>8804</td>
<td>19.720713955008453</td>
<td>19.431893985781933</td>
<td>9.30049177536528</td>
<td>14.224609681307248</td>
<td>23.136480969465936</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>extra</td>
<td>DOUBLE</td>
<td>-7.5</td>
<td>16.0</td>
<td>68</td>
<td>1.400851519300449</td>
<td>1.8259134524837513</td>
<td>0.0</td>
<td>1.0</td>
<td>2.5</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>mta_tax</td>
<td>DOUBLE</td>
<td>-0.5</td>
<td>10.5</td>
<td>11</td>
<td>0.4781669536339025</td>
<td>0.1347045242309791</td>
<td>0.5</td>
<td>0.5</td>
<td>0.5</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>tip_amount</td>
<td>DOUBLE</td>
<td>-67.45</td>
<td>500.0</td>
<td>3783</td>
<td>3.4248225154810834</td>
<td>4.1867407431190955</td>
<td>0.0</td>
<td>2.6928540734898987</td>
<td>4.41006614684763</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>tolls_amount</td>
<td>DOUBLE</td>
<td>-76.38</td>
<td>150.0</td>
<td>1216</td>
<td>0.584599502682299</td>
<td>2.2606473061080656</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>improvement_surcharge</td>
<td>DOUBLE</td>
<td>-1.0</td>
<td>2.0</td>
<td>5</td>
<td>0.9575214064689841</td>
<td>0.26930320533013286</td>
<td>1.0</td>
<td>1.0</td>
<td>1.0</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>total_amount</td>
<td>DOUBLE</td>
<td>-901.0</td>
<td>1690.89</td>
<td>17716</td>
<td>28.429628798927773</td>
<td>24.41309204976698</td>
<td>16.09112832601518</td>
<td>21.539362915884368</td>
<td>31.333575348855142</td>
<td>3833771</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>congestion_surcharge</td>
<td>DOUBLE</td>
<td>-2.5</td>
<td>2.5</td>
<td>6</td>
<td>2.230652282233429</td>
<td>0.8855332647216068</td>
<td>2.5</td>
<td>2.5</td>
<td>2.5</td>
<td>3833771</td>
<td>10.27</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>Airport_fee</td>
<td>DOUBLE</td>
<td>-1.75</td>
<td>1.75</td>
<td>4</td>
<td>0.150372716923517</td>
<td>0.5092291673630285</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>3833771</td>
<td>10.27</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Even though I won’t be doing speed comparisons, I must point out that this description is pretty much instantaneous. A similar operation in <code>pandas</code> would likely be very fast, <strong>but so far I have avoided loading the full dataset in memory!</strong> And while that overhead might not make such a difference with 3.8M rows,</p>
<ul>
<li>I am using a minimal amount of RAM</li>
<li>It will make a difference for datasets 10, 100, or 1000 times larger</li>
</ul>
<p>I know I have 3.8M trips. I also know there are clear outliers. The <code>trip_distance</code> variable has a max of 366343.04 (miles?), and a P75 of 3.4, and a mean of over 5.</p>
<p>Let’s say that I want to do an analysis of taxi speed over time of day. I might want to exclude: * Weekends * Trips over 20 miles * Trips with 0 distance * Duration over a minute</p>
<p>Overall, why should I load into my memory rows I already now know I do not have to use? So While it’s true that a row selection is pretty straightforward to implement not only in SQL, but also in <code>pandas</code>, excel, whataver, the key is that by passing the filter <strong>before</strong> we load the data into the RAM, we’re saving a lot of space, energy, time.</p>
<p>But also, why limiting outselves to rows? If I need only times and distance, why not only load those columns? And maybe computing MpH on the fly?</p>
<div id="85addd71" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> duckdb.sql(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="st">  tpep_pickup_datetime</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="st">  , date_sub('second', tpep_pickup_datetime, tpep_dropoff_datetime) as duration_seconds</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="st">  , trip_distance</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="st">  , 3600*trip_distance/(date_sub('second', tpep_pickup_datetime, tpep_dropoff_datetime)) as mph</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="st">  from 'yellow_tripdata_2024-10.parquet'</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE </span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="st">    trip_distance &lt;= 20 and trip_distance&gt;0 </span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="st">    and dayofweek(tpep_pickup_datetime) between 1 and 5</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="st">    and date_sub('second', tpep_pickup_datetime, tpep_dropoff_datetime)&gt;60</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="st">  """</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>).df()</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"""Loaded </span><span class="sc">{</span>df<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> out of </span><span class="sc">{</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    duckdb<span class="sc">.</span>sql(<span class="st">"select count(*) from 'yellow_tripdata_2024-10.parquet'"</span>)<span class="sc">.</span>fetchone()[<span class="dv">0</span>]</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="sc">}</span><span class="ss"> rows. First five rows:"""</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 2739362 out of 3833771 rows. First five rows:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">tpep_pickup_datetime</th>
<th data-quarto-table-cell-role="th">duration_seconds</th>
<th data-quarto-table-cell-role="th">trip_distance</th>
<th data-quarto-table-cell-role="th">mph</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2024-10-01 00:30:44</td>
<td>1062</td>
<td>3.00</td>
<td>10.169492</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2024-10-01 00:12:20</td>
<td>785</td>
<td>2.20</td>
<td>10.089172</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2024-10-01 00:04:46</td>
<td>546</td>
<td>2.70</td>
<td>17.802198</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2024-10-01 00:12:10</td>
<td>651</td>
<td>3.10</td>
<td>17.142857</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2024-10-01 00:31:20</td>
<td>280</td>
<td>0.97</td>
<td>12.471429</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>But we can take it a step further.</p>
<p>Do I need the microdata at all? At the end of the day, if I just want to plot a graph showing average taxi speed over time of day, why don’t I aggregate already -<strong>without loading every single row in an (expensive) <code>pandas.DataFrame()</code></strong>? We can just import the aggregate data directly. No need to waste memory!</p>
<div id="659c3c84" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># group by {frequency} minutes</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>frequency <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> duckdb.sql(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="ss">f"""</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ss">  with trips as (</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ss">  SELECT</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="ss">  tpep_pickup_datetime</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="ss">  , date_sub('second', tpep_pickup_datetime, tpep_dropoff_datetime) as duration_seconds</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="ss">  , trip_distance</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="ss">  , 3600*trip_distance/(date_sub('second', tpep_pickup_datetime, tpep_dropoff_datetime)) as mph</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="ss">  from 'yellow_tripdata_2024-10.parquet'</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="ss">  WHERE</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="ss">    trip_distance &lt;= 20 and trip_distance&gt;0 </span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="ss">    and dayofweek(tpep_pickup_datetime) between 1 and 5</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="ss">    and date_sub('second', tpep_pickup_datetime, tpep_dropoff_datetime)&gt;60</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="ss">  )</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="ss">  select</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="sc">{</span>frequency<span class="sc">}</span><span class="ss">*((60*hour(tpep_pickup_datetime) + minute(tpep_pickup_datetime))//</span><span class="sc">{</span>frequency<span class="sc">}</span><span class="ss">)/60 as timeday_c</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="ss">    , AVG(mph) as avg_speed</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="ss">    , count(*) as cnt</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="ss">  from trips </span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="ss">  where tpep_pickup_datetime is not null</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="ss">  group by all</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="ss">  """</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>).df()</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"""Loaded </span><span class="sc">{</span>df<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> rows. First five rows:"""</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 144 rows. First five rows:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">timeday_c</th>
<th data-quarto-table-cell-role="th">avg_speed</th>
<th data-quarto-table-cell-role="th">cnt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>14.000000</td>
<td>8.709100</td>
<td>24804</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>14.333333</td>
<td>8.567473</td>
<td>25610</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>16.833333</td>
<td>8.447701</td>
<td>28748</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>18.333333</td>
<td>8.766163</td>
<td>34094</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>20.500000</td>
<td>11.267965</td>
<td>27714</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>And plot the resulting rows. Ta-dah. Don’t need to see the microdata really for this kind of descriptive stats.</p>
<div id="cell-fig-avg_speed" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>ax.scatter(df[<span class="st">"timeday_c"</span>], df[<span class="st">"avg_speed"</span>], s<span class="op">=</span><span class="dv">50</span><span class="op">*</span>df[<span class="st">"cnt"</span>]<span class="op">/</span>df[<span class="st">"cnt"</span>].<span class="bu">max</span>())</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ax.spines[[<span class="st">'right'</span>, <span class="st">'top'</span>]].set_visible(<span class="va">False</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(<span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">25</span>, <span class="dv">1</span>))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(<span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">25</span>, <span class="dv">2</span> ))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>ax.grid(axis<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="dv">22</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">0</span>, <span class="dv">24</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-avg_speed" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-avg_speed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="2024-12_TeachSQLinGradSchool_files/figure-html/fig-avg_speed-output-1.png" width="649" height="416" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-avg_speed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Average taxi speed in NYC is has been about 9 MpH during working hours in October ’24
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
If you read this far…
</div>
</div>
<div class="callout-body-container callout-body">
<p>…you would probably like to plot the same graph for weekends. Try to import it as well as a groupby aggregate 😉. It’s an extra 3 lines in the same query!</p>
</div>
</div>
</section>
<section id="join-join-join" class="level3">
<h3 class="anchored" data-anchor-id="join-join-join">Join, join, join</h3>
<p>Now, the real deal: SQL allows you to do operations that would be very hard - or downright impossible, as they’d overflow your RAM - without. Very often, these operations are about joining different tables together and filtering.</p>
<p>SQL was after all meant to query relational databases. The idea behind relational databases is efficiency. In my experience, their structure appears strange at the eyes of economists. We have been trained to think of orderly panel datasets, NxT, large matrixes ready for regressions. In reality, most data look like the example below.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://planetscale.com/_next/image?url=/assets/blog/content/schema-design-101-relational-databases/db72cc3ac506bec544588454972113c4dc3abe50-1953x1576.png&amp;w=3840&amp;q=75" class="img-fluid figure-img"></p>
<figcaption>Example of a relational database</figcaption>
</figure>
</div>
<p>The data is not stored “ready for analytics”. If you want to, say, regress <code>moneySpent</code> on <code>price</code>, maie controlling for <code>employeeID</code>, you need to join and patch 4 tables together. “SQL” (OLAP engines) is precisely constructed to make those joins on the fly as intuitive, quick, and painless as possible.</p>
<p>Of course, the example alone is a simplistic example. Tipically, data warehouses have hundreds of connected tables, all storing different pieces of information. ANd that’s relevant for you: Because this is the environment your students will meet if they get a job as an analyst in the private sector.</p>
<p><code>JOIN</code>s in SQL are therefore necessarily more powerful than <code>.merge()</code> operations in <code>pandas</code>. Think of <code>JOIN</code>s as constructing behind the curtains all possible combinations across the tables you need to join, and applying filters to select the correct rows. So the <code>ON</code> conditions in <code>JOIN</code>s are pretty much equivalent to <code>WHERE</code> statements.</p>
<p>The consequence is that with SQL you can easily do unequal joins (<code>t1.var1&gt;t2.var2</code>), joins on functions of variables, and so on. These types of <code>JOIN</code>s are way more common than one might think.</p>
<p>Take as an example the table linking clients to primary bank adviser I worked with last week. Its structure is something like the following</p>
<table class="caption-top table">
<caption>An example of a client-adviser relationship table</caption>
<thead>
<tr class="header">
<th>ClientID</th>
<th style="text-align: left;">AdviserID</th>
<th style="text-align: right;">ValidFrom</th>
<th style="text-align: center;">ValidTo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">2021-01-14</td>
<td style="text-align: center;">2021-08-03</td>
</tr>
<tr class="even">
<td>A</td>
<td style="text-align: left;">2</td>
<td style="text-align: right;">2021-08-03</td>
<td style="text-align: center;">2024-06-01</td>
</tr>
<tr class="odd">
<td>A</td>
<td style="text-align: left;">3</td>
<td style="text-align: right;">2024-06-01</td>
<td style="text-align: center;">9999-12-31</td>
</tr>
<tr class="even">
<td>B</td>
<td style="text-align: left;">2</td>
<td style="text-align: right;">2023-12-01</td>
<td style="text-align: center;">9999-12-31</td>
</tr>
</tbody>
</table>
<p>To find out which adviser the client had when they redeemed the mortgage, I would need to do a <code>JOIN</code> based on timestamps.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  r.clientID</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  , r.redemption_date</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  , r.other_stuff</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  , a.AdviserId</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> redemptions <span class="kw">as</span> r</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="kw">left</span> <span class="kw">join</span> advisers <span class="kw">as</span> a</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">on</span> a.ClientId<span class="op">=</span>r.ClientID</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">and</span> r.redemption_time <span class="op">&gt;=</span> r.ValidFrom</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">and</span> r.redemption_time <span class="op">&lt;</span> r.ValidTo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If I had the same tables to join in <code>pandas</code> I would have to proceed in two steps: 1) Join the tables on <code>ClientID</code> 2) Subset the result on the temporal conditions</p>
<p>However, the first join might make the number of rows to explode - going past that step might not even be possible given memory limits.</p>
<p>But does that matter for the work of an academic economist?</p>
<p>It might. For example, think of matching on observables (or identifying a control group.) In our taxi data, let’s say I want to measure the effect of number of passengers on tip rate. And my identification strategy tells me that as long as pick-up, delivery locations, day of the week, time of the day, and airport fee are the same, and distance is within a mile, the number of passenger is randomly assigned. To ensure treatments and controls are not replicated, we can even pick potential treatments as those starting a trip on odd minutes, potential controls as those starting a trip on even minutes.</p>
<blockquote class="blockquote">
<p>Bear with me, it’s the first example I could think of. I assume you’ll have a better identification strategy.</p>
</blockquote>
<p>How would you find a matched control? Well, a single SQL query can do the job.</p>
<div id="adae6118" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> duckdb.sql(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"""</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="st">  with valid_rides as (</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT *</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="st">  from 'yellow_tripdata_2024-10.parquet'</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE </span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="st">    trip_distance &lt;= 20 and trip_distance&gt;0 </span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="st">    and dayofweek(tpep_pickup_datetime) between 1 and 5</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="st">    and date_sub('second', tpep_pickup_datetime, tpep_dropoff_datetime)&gt;60</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="st">    and passenger_count&gt;0</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="st">  )</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="st">  select</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="st">    T.tpep_pickup_datetime as pickup_treat</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="st">    , C.tpep_pickup_datetime as pickup_control</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="st">    , T.tpep_dropoff_datetime as dropoff_treat</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="st">    , C.tpep_dropoff_datetime as dropoff_control</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="st">    , T.passenger_count as passenger_count_treat</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="st">    , C.passenger_count as passenger_count_control</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="st">    , T.tip_amount/T.total_amount as tip_share_treat</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="st">    , C.tip_amount/C.total_amount as tip_share_control</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="st">  from valid_rides as T</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="st">  inner join valid_rides as C</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="st">    ON</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="st">    -- locations must be the same</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="st">    T.PULocationID=C.PULocationID and T.DOLocationID=C.PULocationID</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="st">    -- Airport fee the same</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="st">    and T.Airport_fee=C.Airport_fee</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="st">    -- Same day, same hour</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="st">    and date_trunc('hour', T.tpep_pickup_datetime)=date_trunc('hour', C.tpep_pickup_datetime)</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="st">    -- close enough distance</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="st">    and T.trip_distance between C.trip_distance -0.5 and C.trip_distance +0.5</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="st">    -- same payment type</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="st">    and T.payment_type=C.payment_type</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="st">    -- treated must start at odd minutes</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="st">    and minute(T.tpep_pickup_datetime)%2=1</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="st">    -- controls must start at even minutes</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="st">    and minute(C.tpep_pickup_datetime)%2=0</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="st">    -- and finally remove the same trip</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="st">    and T.tpep_pickup_datetime != C.tpep_pickup_datetime</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="st">    and T.tpep_dropoff_datetime != C.tpep_dropoff_datetime</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="st">  --order by T.tpep_dropoff_datetime</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="st">  """</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>).df()</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"""Loaded </span><span class="sc">{</span>df<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> rows. First five rows:"""</span>)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 1241469 rows. First five rows:
CPU times: user 2.03 s, sys: 181 ms, total: 2.21 s
Wall time: 623 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pickup_treat</th>
<th data-quarto-table-cell-role="th">pickup_control</th>
<th data-quarto-table-cell-role="th">dropoff_treat</th>
<th data-quarto-table-cell-role="th">dropoff_control</th>
<th data-quarto-table-cell-role="th">passenger_count_treat</th>
<th data-quarto-table-cell-role="th">passenger_count_control</th>
<th data-quarto-table-cell-role="th">tip_share_treat</th>
<th data-quarto-table-cell-role="th">tip_share_control</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2024-10-29 15:07:38</td>
<td>2024-10-29 15:48:27</td>
<td>2024-10-29 15:16:00</td>
<td>2024-10-29 15:59:01</td>
<td>1</td>
<td>1</td>
<td>0.167832</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2024-10-29 15:35:37</td>
<td>2024-10-29 15:02:41</td>
<td>2024-10-29 15:45:24</td>
<td>2024-10-29 15:07:57</td>
<td>1</td>
<td>1</td>
<td>0.166667</td>
<td>0.199695</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2024-10-29 15:21:26</td>
<td>2024-10-29 15:18:28</td>
<td>2024-10-29 15:32:50</td>
<td>2024-10-29 15:27:39</td>
<td>1</td>
<td>2</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2024-10-29 15:23:56</td>
<td>2024-10-29 15:06:54</td>
<td>2024-10-29 15:29:49</td>
<td>2024-10-29 15:11:40</td>
<td>1</td>
<td>1</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2024-10-29 15:37:35</td>
<td>2024-10-29 15:18:28</td>
<td>2024-10-29 15:41:04</td>
<td>2024-10-29 15:27:39</td>
<td>1</td>
<td>2</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Granted, it’s a relatively complex query - but does the job nicely. And here I couldn’t help it but printing out the time it took as well.</p>
<p>So, drum rolls… is there any effect?</p>
<p>Of course not, it was a stupid idea.</p>
<div id="788aafbe" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>duckdb.sql(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="st">  select least(passenger_count_treat, 5) as passenger_count_treat</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="st">  , least(passenger_count_control, 5) as passenger_count_control</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="st">  , avg(tip_share_treat - tip_share_control) as effect</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="st">  from df </span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="st">  group by all</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="st">  """</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>).df().pivot(columns<span class="op">=</span><span class="st">'passenger_count_control'</span>, index<span class="op">=</span><span class="st">'passenger_count_treat'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th colspan="5" data-quarto-table-cell-role="th" data-halign="left">effect</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">passenger_count_control</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th">passenger_count_treat</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>0.001226</td>
<td>0.001432</td>
<td>0.003868</td>
<td>0.003036</td>
<td>0.000215</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>-0.000163</td>
<td>-0.000303</td>
<td>0.001733</td>
<td>0.004597</td>
<td>0.002828</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>-0.000645</td>
<td>0.001073</td>
<td>0.004201</td>
<td>0.004506</td>
<td>-0.002845</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>-0.003199</td>
<td>-0.005196</td>
<td>-0.007590</td>
<td>-0.007027</td>
<td>-0.013053</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>0.002610</td>
<td>-0.000297</td>
<td>0.004864</td>
<td>-0.001569</td>
<td>-0.000914</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>But, as always…</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://media1.tenor.com/images/86a7cc1b48c881a8fe892fc74878ff30/tenor.gif?itemid=11921883" class="img-fluid figure-img"></p>
<figcaption>Always.</figcaption>
</figure>
</div>
</section>
</section>
<section id="summing-up" class="level2">
<h2 class="anchored" data-anchor-id="summing-up">Summing up</h2>
<ol type="1">
<li>SQL is useful.
<ul>
<li>It allows you to spare your machine for unnecessary data loads into expensive formats, such as <code>pandas.DataFrame</code>s.</li>
<li>It allows you do to cool joins that you did not dream of doing</li>
</ul></li>
<li>Thanks to <a href="https://duckdb.org">DuckDB</a>, you can easily run SQL queries on your local data.
<ul>
<li>It has both a python and R interface</li>
</ul></li>
<li>Your students will need SQL in the private job market 🙏</li>
</ol>
<p>If you work with students, do yourself, your students, and the whole industry a favor. Learn SQL and introduce it in college/university classes.</p>
<p>Thanks!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/alemartinello\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>